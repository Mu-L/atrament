class t{constructor(t,e){this.x=t,this.y=e}set(t,e){this.x=t,this.y=e}}class e extends t{constructor(){super(0,0),this.down=!1,this.previous=new t(0,0)}}class s{constructor(){this.eventListeners=new Map}addEventListener(t,e){const s=this.eventListeners.get(t)||new Set;s.add(e),this.eventListeners.set(t,s)}removeEventListener(t,e){const s=this.eventListeners.get(t);s&&s.delete(e)}dispatchEvent(t,e){const s=this.eventListeners.get(t);s&&[...s].forEach((t=>t(e)))}}const i=(t,e,s,i)=>{const o=(s-t)**2,r=(i-e)**2;return Math.sqrt(o+r)},o=t=>e=>{!e.isPrimary||e.button>0||(e.cancelable&&e.preventDefault(),t(e))},r=Symbol("atrament mode - draw"),n=Symbol("atrament mode - erase"),h=Symbol("atrament mode - fill"),a=Symbol("atrament mode - disabled"),c=[r,n],l=["weight","smoothing","adaptiveStroke","mode"];class d extends s{adaptiveStroke=!0;canvas;recordStrokes=!1;resolution=window.devicePixelRatio;smoothing=.85;thickness=2;#t;#e=!1;#s=!1;#i=[];#o=null;#r=r;#n=new e;#h=.5;#a;#c=[];#l=2;#d=2;constructor(t,e={}){if("undefined"==typeof window)throw new Error("atrament: looks like we're not running in a browser");super(),this.canvas=d.#m(t,e),this.#t=d.#u(this.canvas,e),this.#p({FillWorker:e.fill}),this.#a=(({canvas:t,move:e,down:s,up:i})=>{const r=o(e),n=o(s),h=o(i);return t.addEventListener("pointermove",r),t.addEventListener("pointerdown",n),document.addEventListener("pointerup",h),document.addEventListener("pointerout",h),()=>{t.removeEventListener("pointermove",r),t.removeEventListener("pointerdown",n),document.removeEventListener("pointerup",h),document.removeEventListener("pointerout",h)}})({canvas:this.canvas,move:this.#v.bind(this),down:this.#g.bind(this),up:this.#w.bind(this)}),l.forEach((t=>{void 0!==e[t]&&(this[t]=e[t])}))}beginStroke(t,e){this.#t.moveTo(t,e),this.#l=this.#d,this.recordStrokes&&(this.strokeTimestamp=performance.now()),this.dispatchEvent("strokestart",{x:t,y:e})}endStroke(t,e){this.dispatchEvent("strokeend",{x:t,y:e}),this.recordStrokes&&this.dispatchEvent("strokerecorded",{stroke:this.currentStroke}),this.#c=[],delete this.strokeTimestamp}draw(e,s,o,n){const h=o||e,a=n||s,c=this.getSmoothingFactor(i(e,s,h,a)),l=e-(e-h)*c,d=s-(s-a)*c,m=i(l,d,h,a);if(this.adaptiveStroke){const t=(m-2)/(98*(1-this.#h))*(this.#k-this.#d)+this.#d;this.#l>t?this.#l-=.25:this.#l<t&&(this.#l+=.25)}else this.#l=this.#d;return this.#t.lineWidth=this.#l,this.#t.beginPath(),this.#t.moveTo(h,a),this.#t.quadraticCurveTo(h,a,l,d),this.#t.closePath(),this.#t.stroke(),this.recordStrokes&&(this.#c.push({point:new t(e,s),time:performance.now()-this.strokeTimestamp}),this.dispatchEvent("segmentdrawn",{stroke:this.currentStroke})),this.#e||this.#r!==r||(this.#e=!0,this.dispatchEvent("dirty")),{x:l,y:d}}clear(){this.#e=!1,this.dispatchEvent("clean");const t=this.mode===n;t&&(this.mode=r),this.#t.save(),this.#t.setTransform(1,0,0,1,0,0),this.#t.clearRect(0,0,this.canvas.width,this.canvas.height),this.#t.restore(),t&&(this.mode=n)}destroy(){this.clear(),this.#a?.()}get color(){return this.#t.strokeStyle}set color(t){if("string"!=typeof t)throw new Error("atrament: wrong argument type setting color");this.#t.strokeStyle=t}get weight(){return this.#d}set weight(t){if("number"!=typeof t)throw new Error("atrament: wrong argument type setting weight");this.#l=t,this.#d=t}get#k(){return this.#d+30}getSmoothingFactor(t){return Math.min(.87,this.smoothing+(t-60)/3e3)}get mode(){return this.#r}set mode(t){switch(t){case n:this.#r=n,this.#t.globalCompositeOperation="destination-out";break;case h:this.#r=h,this.#t.globalCompositeOperation="source-over";break;case a:this.#r=a;break;case r:this.#r=r,this.#t.globalCompositeOperation="source-over";break;default:throw new Error("atrament: mode is not one of the allowed modes.")}}get currentStroke(){return{segments:this.#c.slice(),mode:this.mode,weight:this.weight,smoothing:this.smoothing,color:this.color,adaptiveStroke:this.adaptiveStroke}}get dirty(){return this.#e}static#m(t,e){let s;if(t instanceof window.Node&&"CANVAS"===t.tagName)s=t;else{if("string"!=typeof t)throw new Error(`atrament: can't look for canvas based on '${t}'`);s=document.querySelector(t)}if(!s)throw new Error("atrament: canvas not found");const i=e.resolution||window.devicePixelRatio;return s.width=(e.width||s.width)*i,s.height=(e.height||s.height)*i,s.style.touchAction="none",s}static#u(t,e){const s=t.getContext("2d"),i=e.resolution||window.devicePixelRatio;return s.scale(i,i),s.globalCompositeOperation="source-over",s.globalAlpha=1,s.strokeStyle=e.color||"rgba(0,0,0,1)",s.lineCap="round",s.lineJoin="round",s}#v(t){(t.getCoalescedEvents?.()||[t]).forEach((t=>{const e=t.offsetX,s=t.offsetY;if(this.#n.down&&c.includes(this.#r)){const{x:i,y:o}=this.draw(e,s,this.#n.previous.x,this.#n.previous.y);this.#n.set(e,s),this.#n.previous.set(i,o),this.#h=1===t.pressure?.5:t.pressure||.5}else this.#n.set(e,s),this.#n.previous.set(e,s)}))}#g(t){this.mode!==h?(this.#n.down=!0,this.#v(t),this.beginStroke(this.#n.previous.x,this.#n.previous.y)):this.#f()}#w(t){this.#r!==h&&this.#n.down&&(this.#n.down=!1,this.#n.x===t.offsetX&&this.#n.y===t.offsetY&&c.includes(this.mode)&&this.draw(this.#n.x,this.#n.y,this.#n.previous.x,this.#n.previous.y),this.#n.previous.set(0,0),this.endStroke(this.#n.x,this.#n.y))}#p({FillWorker:t}){t&&(this.#o=new t,this.#o.addEventListener("message",(({data:t})=>{if("fill-result"===t.type){this.#s=!1,this.dispatchEvent("fillend",{});const e=new ImageData(t.result,this.canvas.width,this.canvas.height);this.#t.putImageData(e,0,0),this.#i.length>0&&this.#x(this.#i.shift())}})))}#f(){if(!this.#o)throw new Error("atrament: fill mode only works if the fillWorker option is passed to the Atrament constructor");const{x:t,y:e}=this.#n;this.dispatchEvent("fillstart",{x:t,y:e});const s=Array.from(this.#t.getImageData(t,e,1,1).data),i={color:this.color,globalAlpha:this.#t.globalAlpha,width:this.canvas.width,height:this.canvas.height,startColor:s,startX:t*this.resolution,startY:e*this.resolution};this.#s?this.#i.push(i):(this.#s=!0,this.#x(i))}#x(t){const e=this.#t.getImageData(0,0,this.canvas.width,this.canvas.height).data;this.#o?.postMessage({image:e,...t},[e.buffer])}}export{a as MODE_DISABLED,r as MODE_DRAW,n as MODE_ERASE,h as MODE_FILL,d as default};
